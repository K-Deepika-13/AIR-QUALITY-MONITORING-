<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Air Quality Monitor</title>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3a0ca3;
      --accent-color: #4cc9f0;
      --success-color: #4ade80;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7ff 0%, #eef1f9 100%);
      color: var(--dark-color);
      min-height: 100vh;
      font-size: 1.2rem;
    }

    .dashboard-container {
      padding: 1.5rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
    }

    .user-welcome {
      display: flex;
      align-items: center;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      color: white;
      font-size: 1.5rem;
    }

    .user-info h2 {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--dark-color);
    }

    .user-info p {
      color: #6c757d;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn {
      border-radius: 12px;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .btn i {
      margin-right: 0.5rem;
    }

    .btn-outline-secondary {
      border-color: #cbd5e1;
      color: #64748b;
    }

    .btn-outline-secondary:hover {
      background-color: #f1f5f9;
      border-color: #94a3b8;
    }

    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .btn-danger:hover {
      background-color: #dc2626;
      border-color: #dc2626;
      transform: translateY(-2px);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .project-hero {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem;
      border-radius: 18px;
      background: linear-gradient(135deg, #5b21b6, #2563eb);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .project-logo {
      width: 72px;
      height: 72px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.4rem;
      background: radial-gradient(circle at top, #fcd34d, #f97316);
      color: #0f172a;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .project-hero-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .project-hero-image {
      width: 90px;
      height: 90px;
      border-radius: 24px;
      background: conic-gradient(from 180deg, #facc15, #f472b6, #38bdf8, #a5b4fc, #facc15);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
      margin-left: auto;
    }

    .project-pills {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .project-pill {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1rem 1.25rem;
      border: 1px solid #e2e8f0;
    }

    .project-pill span {
      display: flex;
      align-items: center;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 0.35rem;
    }

    .project-pill p {
      margin: 0;
      font-size: 0.9rem;
      color: #475569;
    }

    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .project-panel {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      padding: 1rem 1.25rem;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .project-panel h6 {
      font-weight: 600;
      color: var(--dark-color);
    }

    .project-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .project-list li {
      display: flex;
      gap: 0.4rem;
      color: #475569;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }

    .project-list li i {
      color: var(--primary-color);
      margin-top: 0.15rem;
    }

    .card {
      border: none;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1.25rem 1.5rem;
      border-radius: 16px 16px 0 0 !important;
    }

    .card-title {
      display: flex;
      align-items: center;
      font-weight: 600;
      margin: 0;
      color: var(--dark-color);
    }

    .card-title i {
      margin-right: 0.75rem;
      color: var(--primary-color);
    }

    .card-body {
      padding: 1.5rem;
    }

    .sensor-data {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .sensor-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
      border-left: 4px solid var(--primary-color);
    }

    .sensor-info {
      display: flex;
      flex-direction: column;
    }

    .sensor-label {
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 0.25rem;
    }

    .sensor-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--dark-color);
    }

    .sensor-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: rgba(67, 97, 238, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-size: 1.5rem;
    }

    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-weight: 500;
      font-size: 0.875rem;
    }

    .ai-analysis-card {
      grid-column: span 2;
    }

    .ai-analysis-content {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .ai-description {
      color: #64748b;
      line-height: 1.6;
    }

    .ai-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }

    .btn-success:hover {
      background-color: #22c55e;
      border-color: #22c55e;
      transform: translateY(-2px);
    }

    .spinner-border {
      width: 1.25rem;
      height: 1.25rem;
    }

    .ai-result {
      background: #f0f9ff;
      border-radius: 12px;
      padding: 1.25rem;
      border-left: 4px solid var(--accent-color);
      transition: background 0.3s ease;
    }

    .ai-result-empty {
      white-space: normal;
      color: #64748b;
    }

    .health-report-card {
      grid-column: span 2;
    }

    .report-upload {
      border: 2px dashed #d4d8f0;
      border-radius: 16px;
      padding: 1.25rem;
      text-align: center;
      background: #fdfaff;
    }

    .report-upload label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 999px;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    #healthReportInput {
      display: none;
    }

    .report-status {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #475569;
      min-height: 24px;
    }

    .report-list {
      margin-top: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 260px;
      overflow-y: auto;
    }

    .report-item {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.85rem 1rem;
      background: white;
    }

    .report-item h6 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--dark-color);
    }

    .report-item p {
      margin: 0.35rem 0 0;
      font-size: 0.85rem;
      color: #64748b;
    }

    .ai-result-ready {
      background: white;
      border: 1px solid #e2e8f0;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .ai-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
    }

    .ai-summary-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #e2e8f0;
    }

    .ai-label {
      font-size: 0.8rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
      margin-bottom: 0.35rem;
    }

    .ai-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .chip-safe {
      background: rgba(74, 222, 128, 0.15);
      color: #15803d;
    }

    .chip-unsafe {
      background: rgba(239, 68, 68, 0.15);
      color: #b91c1c;
    }

    .chip-normal {
      background: rgba(245, 158, 11, 0.15);
      color: #b45309;
    }

    .chip-unknown {
      background: rgba(148, 163, 184, 0.2);
      color: #475569;
    }

    .ai-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--dark-color);
    }

    .ai-subtext {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .ai-section {
      margin-top: 1.25rem;
    }

    .ai-section h6 {
      font-weight: 600;
      margin-bottom: 0.35rem;
      color: var(--dark-color);
    }

    .ai-section p {
      margin: 0;
      color: #475569;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .ai-status {
      display: flex;
      gap: 1rem;
    }

    .status-item {
      display: flex;
      flex-direction: column;
    }

    .status-label {
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 0.25rem;
    }

    .status-value {
      font-weight: 500;
      color: var(--dark-color);
    }

    .analyses-table-container {
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .table-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .table-header h4 {
      display: flex;
      align-items: center;
      margin: 0;
      font-weight: 600;
    }

    .table-header i {
      margin-right: 0.75rem;
      color: var(--primary-color);
    }

    .table {
      margin: 0;
    }

    .table thead th {
      background-color: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 1.25rem;
      font-weight: 600;
      color: #475569;
    }

    .table tbody td {
      padding: 1rem 1.25rem;
      vertical-align: middle;
      border-bottom: 1px solid #e2e8f0;
    }

    .badge {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-weight: 500;
    }

    .bg-success {
      background-color: var(--success-color) !important;
    }

    .bg-warning {
      background-color: var(--warning-color) !important;
    }

    .bg-danger {
      background-color: var(--danger-color) !important;
    }

    .bg-secondary {
      background-color: #94a3b8 !important;
    }

    /* Animation for sensor updates */
    @keyframes highlight {
      0% { background-color: rgba(245, 158, 11, 0.3); }
      100% { background-color: transparent; }
    }

    .highlight {
      animation: highlight 1s ease;
    }

    #map {
      height: 300px;
      width: 100%;
      border-radius: 12px;
    }

    .info-control {
      padding: 14px;
      background: white;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 12px;
      font-size: 0.95rem;
      max-width: 280px;
      line-height: 1.6;
    }

    .pollution-control {
      min-width: 240px;
      text-align: center;
    }

    .pollution-control .pollution-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--danger-color);
      display: block;
      margin-bottom: 0.25rem;
    }

    .pollution-control .pollution-meta {
      font-size: 0.85rem;
      color: #64748b;
    }

    .search-wrapper {
      position: relative;
    }

    .geocode-results {
      position: absolute;
      top: calc(100% + 0.25rem);
      left: 0;
      width: 100%;
      max-height: 260px;
      overflow-y: auto;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      z-index: 1056;
      display: none;
    }

    .geocode-results.show {
      display: block;
    }

    .geocode-results button {
      width: 100%;
      background: transparent;
      border: none;
      text-align: left;
      padding: 0.85rem 1rem;
      font-size: 0.95rem;
      color: var(--dark-color);
      border-bottom: 1px solid #e2e8f0;
    }

    .geocode-results button:last-child {
      border-bottom: none;
    }

    .geocode-results button:hover,
    .geocode-results button:focus {
      background-color: #f8fafc;
    }

    .geocode-results span {
      display: block;
      color: #64748b;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      .ai-analysis-card {
        grid-column: span 1;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .ai-actions {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .ai-status {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <div class="user-welcome">
        <div class="user-avatar">
          <i class="bi bi-person-fill"></i>
        </div>
        <div class="user-info">
          <h2>Welcome, {{ user.username }}!</h2>
          <p>Monitor your environment's air quality in real-time</p>
        </div>
      </div>
      <div class="header-actions">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mapModal">
          <i class="bi bi-map"></i> Map View
        </button>
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#growthModal">
          <i class="bi bi-graph-up-arrow"></i> Growth Curve
        </button>
        <a href="{{ url_for('profile') }}" class="btn btn-outline-secondary">
          <i class="bi bi-person"></i> Profile
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-4">
        <div class="card" style="height:100%">
          <div class="card-header">
            <h5 class="card-title mb-1"><i class="bi bi-sunrise"></i> Fresh Air Playbook</h5>
            <small class="text-muted">Quick daily actions</small>
          </div>
          <div class="card-body">
            <p class="mb-3">Use this mini checklist to keep your indoor air balanced while the station watches outdoor trends.</p>
            <ul class="list-unstyled small mb-0">
              <li class="mb-3">
                <div class="fw-semibold"><i class="bi bi-wind me-2 text-primary"></i>10-Min Ventilation</div>
                <span class="text-muted">Open opposite windows briefly during low AQI hours.</span>
              </li>
              <li class="mb-3">
                <div class="fw-semibold"><i class="bi bi-plant me-2 text-success"></i>Green Corner</div>
                <span class="text-muted">Snake plant or peace lily near the kit helps absorb VOCs.</span>
              </li>
              <li>
                <div class="fw-semibold"><i class="bi bi-droplet me-2 text-info"></i>Humidity Balance</div>
                <span class="text-muted">Aim for 40–60%. Dehumidify if sensors show high moisture.</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card" style="height:100%">
          <div class="card-header">
            <h5 class="card-title mb-1"><i class="bi bi-stars"></i> Air & Wellness Digest</h5>
            <small class="text-muted">Global air cues + healthy habits</small>
          </div>
          <div class="card-body">
            <div class="project-hero mb-4">
              <div class="project-logo">AW</div>
              <div>
                <div class="project-hero-title">Skyline Harmony</div>
                <p class="mb-0">Colorful indicators summarize worldwide AQI snapshots and matching wellness nudges.</p>
              </div>
              <div class="project-hero-image" aria-hidden="true"></div>
            </div>
            <div class="project-pills">
              <div class="project-pill">
                <span><i class="bi bi-globe2 me-2"></i>AirQuality Beat</span>
                <p>Metro averages for Delhi, Singapore, and São Paulo refresh hourly to show trending spikes.</p>
              </div>
              <div class="project-pill">
                <span><i class="bi bi-activity me-2"></i>Health Signals</span>
                <p>Heat + humidity overlays highlight dehydration windows and when to slow strenuous chores.</p>
              </div>
              <div class="project-pill">
                <span><i class="bi bi-airplane me-2"></i>Travel Radar</span>
                <p>Route-ready badges mark cities with pollen blooms or smoke advisories before you fly.</p>
              </div>
            </div>
            <div class="project-grid">
              <div class="project-panel">
                <h6 class="mb-2">AirQuality Snapshot</h6>
                <ul class="project-list">
                  <li><i class="bi bi-check-lg"></i>AQI &lt; 80: open windows for 15 minutes and air linens.</li>
                  <li><i class="bi bi-check-lg"></i>AQI 80–150: switch to recirculation and run HEPA filters.</li>
                  <li><i class="bi bi-check-lg"></i>AQI &gt; 150: pause outdoor runs and rely on indoor plants.</li>
                </ul>
              </div>
              <div class="project-panel">
                <h6 class="mb-2">Wellness Reminders</h6>
                <ul class="project-list">
                  <li><i class="bi bi-check-lg"></i>Drink 250 ml water every hour when humidity climbs past 70%.</li>
                  <li><i class="bi bi-check-lg"></i>Use saline sprays before bedtime if pollen alerts remain red.</li>
                  <li><i class="bi bi-check-lg"></i>Schedule deep cleaning during Safe periods to avoid dust recirculation.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Sensor Data Card -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="bi bi-speedometer2"></i> Live Sensor Data
          </h5>
        </div>
        <div class="card-body">
          <div class="sensor-data">
            <div class="sensor-item">
              <div class="sensor-info">
                <span class="sensor-label">Temperature</span>
                <span class="sensor-value" id="temp">{{ latest.Temperature }}</span>
              </div>
              <div class="sensor-icon">
                <i class="bi bi-thermometer-half"></i>
              </div>
            </div>
            <div class="sensor-item">
              <div class="sensor-info">
                <span class="sensor-label">Humidity</span>
                <span class="sensor-value" id="hum">{{ latest.Humidity }}</span>
              </div>
              <div class="sensor-icon">
                <i class="bi bi-droplet-half"></i>
              </div>
            </div>
            <div class="sensor-item">
              <div class="sensor-info">
                <span class="sensor-label">Gas Level</span>
                <span class="sensor-value" id="gas">{{ latest.Gas }}</span>
              </div>
              <div class="sensor-icon">
                <i class="bi bi-wind"></i>
              </div>
            </div>
            <div class="sensor-item">
              <div class="sensor-info">
                <span class="sensor-label">Air Quality</span>
                <span id="status">
                  {% set lg = latest.Gas %}
                  {% if lg is not none %}
                    {% if (lg|float >= 180) and (lg|float < 380) %}
                      <span class="status-badge bg-success text-white">Safe</span>
                    {% elif (lg|float >= 380) and (lg|float <= 1024) %}
                      <span class="status-badge bg-danger text-white">Unsafe</span>
                    {% else %}
                      <span class="status-badge bg-warning text-dark">Normal</span>
                    {% endif %}
                  {% else %}
                    <span class="status-badge bg-secondary text-white">—</span>
                  {% endif %}
                </span>
              </div>
              <div class="sensor-icon">
                <i class="bi bi-shield-check"></i>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <small class="text-muted">
              <i class="bi bi-clock me-1"></i> Last updated: <span id="timestamp">{{ latest.timestamp }}</span>
            </small>
          </div>
        </div>
      </div>

      <!-- AI Analysis Card -->
      <div class="card ai-analysis-card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="bi bi-robot"></i> AI Health Analysis
          </h5>
        </div>
        <div class="card-body">
          <div class="ai-analysis-content">
            <p class="ai-description">
              Get personalized health insights based on your profile conditions and current environmental data. 
              Our AI analyzes potential risks and provides recommendations.
            </p>
            
            <div class="ai-actions">
              <button id="runAnalysisBtn" class="btn btn-success">
                <i class="bi bi-play-circle"></i> Run AI Analysis
              </button>
              <div id="aiSpinner" class="spinner-border text-success" role="status" style="display:none;"></div>
            </div>
            
            <div id="aiLatest" class="ai-result ai-result-empty">No analysis run yet. Click the button to get insights.</div>
            
            <div class="ai-status">
              <div class="status-item">
                <span class="status-label">Email Notification</span>
                <span class="status-value" id="aiEmailResult">—</span>
              </div>
              <div class="status-item">
                <span class="status-label">Last Analysis</span>
                <span class="status-value" id="aiLastTime">—</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Health Report Card -->
      <div class="card health-report-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-0"><i class="bi bi-file-medical"></i> GenAI Health Report</h5>
            <small class="text-muted">Upload a PDF or image to auto-summarize risks</small>
          </div>
          <span class="badge bg-info text-dark">Auto</span>
        </div>
        <div class="card-body">
          <div class="report-upload">
            <p class="mb-1">Drop a medical report or tap below to select one.</p>
            <small class="text-muted">Accepted: PDF, PNG, JPG • Max 20 MB</small>
            <div>
              <label for="healthReportInput"><i class="bi bi-upload"></i> Upload Report</label>
              <input type="file" id="healthReportInput" accept="application/pdf,image/png,image/jpeg">
            </div>
          </div>
          <div class="report-status" id="reportStatus"></div>
          <div class="report-list" id="reportList">
            <p class="text-muted small mb-0">No reports uploaded yet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Past Analyses Table -->
    <div class="analyses-table-container">
      <div class="table-header">
        <h4>
          <i class="bi bi-clock-history"></i> Your Past Analyses
        </h4>
        <div style="float:right; margin-top:-36px;">
          <form id="pruneForm" method="POST" action="{{ url_for('prune_analyses') }}" onsubmit="return confirm('Delete the oldest 50 analyses? This cannot be undone.');">
            <input type="hidden" name="count" value="50">
            <button type="submit" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-trash"></i> Remove 50 past analyses
            </button>
          </form>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Disease</th>
              <th>Temperature</th>
              <th>Humidity</th>
              <th>Gas</th>
              <th>Status</th>
              <th>AI Result</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
            {% for r in records %}
            <tr>
              <td>{{ r[0] }}</td>
              <td>{{ r[1] }}</td>
              <td>{{ r[2] }}</td>
              <td>{{ r[3] }}</td>
              <td>{{ r[4] }}</td>
              <td>
                {% set g = r[4] %}
                {% if g is none %}
                  <span class="badge bg-secondary">—</span>
                {% else %}
                  {% if (g|float >= 180) and (g|float < 380) %}
                    <span class="badge bg-success">Safe</span>
                  {% elif (g|float >= 380) and (g|float <= 1024) %}
                    <span class="badge bg-danger">Unsafe</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Normal</span>
                  {% endif %}
                {% endif %}
              </td>
              <td style="max-width:320px;white-space:pre-wrap;">{{ r[5] }}</td>
              <td>{{ r[6] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Full Screen Map Modal -->
  <div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-geo-alt-fill"></i> Map View</h5>
          <div class="search-wrapper ms-3" style="max-width: 320px;">
            <div class="input-group">
              <input type="text" class="form-control form-control-sm" id="locationSearch" placeholder="Search location...">
              <button class="btn btn-sm btn-outline-primary" type="button" id="searchBtn"><i class="bi bi-search"></i></button>
            </div>
            <div id="geocodeResults" class="geocode-results"></div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="locateBtn" title="My Location">
            <i class="bi bi-crosshair"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div id="fullMap" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="growthModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-graph-up"></i> Growth Curve</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Visualizing the latest 10 readings for temperature, humidity, and gas concentration.</p>
          <div class="ratio ratio-16x9">
            <canvas id="growthChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(function(){
      // Global map variables
      var map = null;
      var sensorMarker = null;
      var sensorCircle = null;
      var infoControl = null;
      var pollutionControl = null;
      var growthChart = null;
      
      // State variables
      var currentLat = 13.0827;
      var currentLng = 80.2707;
      var currentZoom = 13;
      
      // Poll /api/data for live updates (every 2 seconds)
      const POLL_INTERVAL = 2000;
      const MAP_POLL_INTERVAL = 5 * 60 * 1000;
      let last = { Temperature: null, Humidity: null, Gas: null, timestamp: null };
      let currentLocationName = "Sensor Location";
      let growthSeries = [];
      let mapPollTimer = null;
      let geocodeResultsData = [];
      let lastSearchQuery = '';
      const LOCATION_OVERRIDES = [
        {
          keywords: ['m kumarasamy', 'kumarasamy college', 'm.kumarasamy'],
          bbox: { latMin: 10.9, latMax: 11.1, lonMin: 77.95, lonMax: 78.1 },
          label: 'M. Kumarasamy College of Engineering, Thalavapalayam, Karur'
        }
      ];

      const MAX_HEALTH_REPORTS = 20;
      const REPORT_STATUS_CLASSES = 'text-success text-danger text-warning text-muted text-info';
      const $reportStatus = $('#reportStatus');
      const $reportList = $('#reportList');
      const $reportInput = $('#healthReportInput');
      let healthReports = [];

      function refreshGrowthSeriesFromApi(callback){
        $.getJSON('/api/data')
          .done(function(resp){
            if(resp && Array.isArray(resp.sensor_data)){
              growthSeries = resp.sensor_data.slice();
              if(growthChart){
                updateGrowthChart(growthSeries);
              }
            }
            if(typeof callback === 'function') callback();
          });
      }

      function escapeHtml(str){
        if(str === null || str === undefined) return '';
        return String(str).replace(/[&<>"']/g, function(ch){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]);
        });
      }

      function withLineBreaks(str){
        return escapeHtml(str || '').replace(/\n/g, '<br>');
      }

      function setReportStatus(message, cls){
        if(!$reportStatus.length) return;
        $reportStatus.removeClass(REPORT_STATUS_CLASSES);
        if(message){
          $reportStatus.text(message);
          if(cls) $reportStatus.addClass(cls);
        } else {
          $reportStatus.text('');
        }
      }

      function renderReportList(items){
        if(!$reportList.length) return;
        if(!items || !items.length){
          $reportList.html('<p class="text-muted small mb-0">No reports uploaded yet.</p>');
          return;
        }
        const html = items.map(function(item){
          const name = escapeHtml(item.name || 'Report');
          const created = escapeHtml(item.created_at || '—');
          const mime = item.mime ? ` • ${escapeHtml(item.mime)}` : '';
          const summary = withLineBreaks(item.summary || 'No summary available.');
          return `<div class="report-item"><h6>${name}</h6><small class="text-muted d-block">${created}${mime}</small><p>${summary}</p></div>`;
        }).join('');
        $reportList.html(html);
      }

      function fetchHealthReports(){
        $.getJSON('/api/health_reports')
          .done(function(resp){
            const data = resp && Array.isArray(resp.reports) ? resp.reports : [];
            healthReports = data.slice(0, MAX_HEALTH_REPORTS);
            renderReportList(healthReports);
          })
          .fail(function(){
            setReportStatus('Unable to load health reports.', 'text-danger');
          });
      }

      function uploadHealthReport(file){
        if(!file) return;
        const lowerName = (file.name || '').toLowerCase();
        const allowed = ['.pdf', '.png', '.jpg', '.jpeg'];
        const isAllowed = allowed.some(function(ext){ return lowerName.endsWith(ext); });
        if(!isAllowed){
          setReportStatus('Unsupported file type.', 'text-danger');
          return;
        }
        if(file.size > 20 * 1024 * 1024){
          setReportStatus('File exceeds 20 MB limit.', 'text-danger');
          return;
        }
        const formData = new FormData();
        formData.append('report', file, file.name);
        setReportStatus('Uploading...', 'text-muted');
        $reportInput.prop('disabled', true);
        $.ajax({
          url: '/api/health_reports',
          method: 'POST',
          data: formData,
          processData: false,
          contentType: false
        })
        .done(function(){
          setReportStatus('Report analyzed successfully.', 'text-success');
          $reportInput.val('');
          fetchHealthReports();
        })
        .fail(function(xhr){
          let msg = 'Upload failed. Please try again.';
          if(xhr && xhr.responseJSON && xhr.responseJSON.error){
            const code = xhr.responseJSON.error;
            if(code === 'missing_file') msg = 'No file received.';
            else if(code === 'empty_filename') msg = 'Invalid filename.';
            else if(code === 'unsupported_type') msg = 'Unsupported file type.';
            else if(code === 'save_failed') msg = 'Unable to save file.';
          }
          setReportStatus(msg, 'text-danger');
        })
        .always(function(){
          $reportInput.prop('disabled', false);
        });
      }

      function applyLocationOverrides(label, lat, lon, queryText){
        const q = (queryText || '').toLowerCase();
        const labelLower = (label || '').toLowerCase();
        for(const entry of LOCATION_OVERRIDES){
          const hasKeyword = entry.keywords.some(k => q.includes(k) || labelLower.includes(k));
          if(!hasKeyword) continue;
          const bbox = entry.bbox;
          let matchesBox = true;
          if(bbox){
            matchesBox = lat != null && lon != null && lat >= bbox.latMin && lat <= bbox.latMax && lon >= bbox.lonMin && lon <= bbox.lonMax;
          }
          if(matchesBox){
            return entry.label;
          }
        }
        return label;
      }

      function formatLocationLabel(source, fallback, queryText, coords){
        const fb = fallback || 'Selected location';
        if(!source) return fb;
        if(typeof source === 'string'){
          const trimmed = source.trim();
          return trimmed || fb;
        }
        const base = source.result && typeof source.result === 'object' ? source.result : source;
        const address = base.address || {};
        let latVal = coords && typeof coords.lat === 'number' ? coords.lat : null;
        let lonVal = coords && typeof coords.lon === 'number' ? coords.lon : null;
        if(latVal === null && base.lat !== undefined){
          const parsed = parseFloat(base.lat);
          if(!isNaN(parsed)) latVal = parsed;
        }
        if(lonVal === null && base.lon !== undefined){
          const parsed = parseFloat(base.lon);
          if(!isNaN(parsed)) lonVal = parsed;
        }
        const candidateNames = [
          base.name,
          (base.display_name && base.display_name.split(',')[0]),
          address.college,
          address.university,
          address.school,
          address.building,
          address.amenity
        ].filter(Boolean).map(v => String(v).trim()).filter(Boolean);
        const name = candidateNames.length ? candidateNames[0] : null;
        const locality = [address.hamlet, address.village, address.suburb, address.locality, address.town, address.city]
          .find(v => v && String(v).trim());
        const district = [address.county, address.district, address.state_district]
          .find(v => v && String(v).trim());
        const state = [address.state, address.region]
          .find(v => v && String(v).trim());
        const country = address.country && String(address.country).trim();
        const pieces = [];
        if(name) pieces.push(name);
        if(locality && (!name || locality.toLowerCase() !== name.toLowerCase())) pieces.push(locality);
        if(district && !pieces.includes(district)) pieces.push(district);
        if(state && !pieces.includes(state)) pieces.push(state);
        if(country && !pieces.includes(country)) pieces.push(country);
        let labelParts = pieces.length ? pieces.slice() : ((base.display_name && String(base.display_name).trim()) ? [String(base.display_name).trim()] : [fb]);
        labelParts = labelParts
          .join(', ')
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);
        const lowerSet = new Set(labelParts.map(p => p.toLowerCase()));
        const segments = (queryText || '').split(',').map(s => s.trim()).filter(Boolean);
        segments.forEach(seg => {
          const low = seg.toLowerCase();
          if(seg && !lowerSet.has(low)) {
            labelParts.push(seg);
            lowerSet.add(low);
          }
        });
        const combined = labelParts.join(', ') || fb;
        return applyLocationOverrides(combined, latVal, lonVal, queryText);
      }

      function ensureGrowthChart(){
        var canvas = document.getElementById('growthChart');
        if(!canvas || growthChart) return;
        const palette = {
          temp: '#f97316',
          hum: '#8b5cf6',
          gas: '#facc15'
        };
        growthChart = new Chart(canvas, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'Temperature (°C)',
                data: [],
                borderColor: palette.temp,
                backgroundColor: 'rgba(249,115,22,0.08)',
                tension: 0.45,
                yAxisID: 'tempHum',
                spanGaps: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2
              },
              {
                label: 'Humidity (%)',
                data: [],
                borderColor: palette.hum,
                backgroundColor: 'rgba(139,92,246,0.08)',
                tension: 0.45,
                yAxisID: 'tempHum',
                spanGaps: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2
              },
              {
                label: 'Gas (ppm)',
                data: [],
                borderColor: palette.gas,
                backgroundColor: 'rgba(250,204,21,0.1)',
                tension: 0.45,
                yAxisID: 'gas',
                spanGaps: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
              padding: { top: 32, right: 28, bottom: 40, left: 20 }
            },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: { usePointStyle: true, padding: 18 }
              },
              tooltip: {
                enabled: true,
                displayColors: true,
                callbacks: {
                  label: function(context){
                    const value = context.formattedValue || '—';
                    return `${context.dataset.label}: ${value}`;
                  }
                }
              },
              title: {
                display: true,
                text: 'Air Quality Trends',
                align: 'start',
                font: { size: 18, weight: '600' },
                color: '#0f172a',
                padding: { bottom: 12 }
              },
              subtitle: {
                display: true,
                text: 'Tracking temperature, humidity, and gas levels over recent samples',
                align: 'start',
                color: '#64748b',
                padding: { bottom: 24 }
              }
            },
            scales: {
              tempHum: {
                type: 'linear',
                position: 'left',
                ticks: { color: '#475569', padding: 8 },
                title: { display: true, text: '°C / %', color: '#475569' },
                grid: { drawBorder: false }
              },
              gas: {
                type: 'linear',
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: '#92400e', padding: 8 },
                title: { display: true, text: 'Gas ppm', color: '#92400e' }
              },
              x: {
                ticks: {
                  color: '#475569',
                  maxRotation: 0,
                  minRotation: 0,
                  autoSkip: true,
                  autoSkipPadding: 24,
                  maxTicksLimit: 4,
                  padding: 12,
                  font: { size: 11 },
                  callback: function(value){
                    if(!this || typeof this.getLabelForValue !== 'function') return value;
                    const label = this.getLabelForValue(value) || '';
                    if(typeof label === 'string' && label.includes(' ')){
                      const parts = label.split(' ');
                      const date = parts[0];
                      const time = parts[1] || '';
                      return `${date}\n${time}`;
                    }
                    return label;
                  }
                },
                grid: { display: false }
              }
            }
          }
        });
      }

      function numericValueOrNull(val){
        if(val === null || val === undefined) return null;
        var num = parseFloat(val);
        return isNaN(num) ? null : num;
      }

      function updateGrowthChart(series){
        if(!growthChart || !Array.isArray(series)) return;
        var labels = [];
        var temps = [];
        var hums = [];
        var gases = [];
        series.forEach(function(item){
          labels.push(item.timestamp || '—');
          temps.push(numericValueOrNull(item.Temperature));
          hums.push(numericValueOrNull(item.Humidity));
          gases.push(numericValueOrNull(item.Gas));
        });
        growthChart.data.labels = labels;
        growthChart.data.datasets[0].data = temps;
        growthChart.data.datasets[1].data = hums;
        growthChart.data.datasets[2].data = gases;
        growthChart.update('none');
      }

      function chipClassForStatus(status){
        const s = (status || '').toLowerCase();
        if(s === 'unsafe') return 'chip-unsafe';
        if(s === 'safe') return 'chip-safe';
        if(s === 'normal') return 'chip-normal';
        return 'chip-unknown';
      }

      function renderAnalysisDetails(details){
        if(!details || Object.keys(details).length === 0){
          return 'Analysis complete. No structured summary available.';
        }
        const status = (details.status || 'UNKNOWN').toUpperCase();
        const chipClass = chipClassForStatus(status);
        const tempVal = details.temperature === null || details.temperature === undefined ? '—' : `${details.temperature}°C`;
        const humVal = details.humidity === null || details.humidity === undefined ? '—' : `${details.humidity}%`;
        const gasVal = details.gas === null || details.gas === undefined ? '—' : `${details.gas} ppm`;
        const timeVal = details.timestamp ? escapeHtml(details.timestamp) : '—';
        const conds = (details.conditions && details.conditions.length)
          ? details.conditions.map(escapeHtml).join(', ')
          : 'None reported';
        return `
          <div class="ai-summary-grid">
            <div class="ai-summary-card">
              <span class="ai-label">Status</span>
              <span class="ai-chip ${chipClass}">${status}</span>
            </div>
            <div class="ai-summary-card">
              <span class="ai-label">Temperature</span>
              <span class="ai-value">${tempVal}</span>
            </div>
            <div class="ai-summary-card">
              <span class="ai-label">Humidity</span>
              <span class="ai-value">${humVal}</span>
            </div>
            <div class="ai-summary-card">
              <span class="ai-label">Gas</span>
              <span class="ai-value">${gasVal}</span>
            </div>
            <div class="ai-summary-card">
              <span class="ai-label">Recorded</span>
              <span class="ai-value">${timeVal}</span>
              <span class="ai-subtext">Local time</span>
            </div>
          </div>
          <div class="ai-section">
            <h6>Health Profile</h6>
            <p>${conds}</p>
          </div>
          <div class="ai-section">
            <h6>Personalized Guidance</h6>
            <p>${withLineBreaks(details.risk_text || '—')}</p>
          </div>
          <div class="ai-section">
            <h6>AI Insights</h6>
            <p>${withLineBreaks(details.ai_text || '—')}</p>
          </div>
        `;
      }

      // Initialize Map Function
      function initMap() {
        // If map exists, remove it to reset the container
        if (map) {
            map.remove();
        }

        // Create map
        map = L.map('fullMap').setView([currentLat, currentLng], currentZoom);

        // Use standard OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add Marker
        sensorMarker = L.marker([currentLat, currentLng]).addTo(map)
            .bindPopup('Waiting for data...')
            .openPopup();

        // Add Circle
        sensorCircle = L.circle([currentLat, currentLng], {
            color: 'grey',
            fillColor: 'grey',
            fillOpacity: 0.5,
            radius: 500
        }).addTo(map);

        // Add Info Control
        infoControl = L.control({position: 'bottomleft'});
        infoControl.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info-control');
            this.update();
            return this._div;
        };
        infoControl.update = function () {
            const label = currentLocationName ? escapeHtml(currentLocationName) : 'Waiting for location...';
            this._div.innerHTML = '<b><i class="bi bi-geo-alt"></i> Location:</b><br>' + label;
        };
        infoControl.addTo(map);

        pollutionControl = L.control({ position: 'bottomright' });
        pollutionControl.onAdd = function () {
            this._div = L.DomUtil.create('div', 'info-control pollution-control');
            this.update();
            return this._div;
        };
        pollutionControl.update = function (data) {
            const gas = data && data.Gas !== undefined && data.Gas !== null ? data.Gas : '—';
            const ts = data && data.timestamp ? data.timestamp : 'Waiting...';
            this._div.innerHTML = `
              <div class="mb-1"><i class="bi bi-cloud-fog2"></i> Pollution Level</div>
              <span class="pollution-value">${gas} ppm</span>
              <span class="pollution-meta">Updated ${ts}</span>
            `;
        };
        pollutionControl.addTo(map);

        // Map Click Event
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            updateMapLocation(lat, lng);
            
            // Fetch address
            $.getJSON('/api/reverse_geocode', { lat: lat, lon: lng })
              .done(function(resp) {
                const data = resp && resp.result ? resp.result : resp;
                if(data) {
                    currentLocationName = formatLocationLabel(data, currentLocationName, null, { lat: lat, lon: lng });
                    updateLatest({latest: last});
                    sensorMarker.openPopup();
                }
              })
              .fail(function(){
                console.log('Reverse geocode failed');
              });
        });
        
        // Update map state on move
        map.on('moveend', function() {
            var center = map.getCenter();
            currentLat = center.lat;
            currentLng = center.lng;
            currentZoom = map.getZoom();
        });
      }

      function updateMapLocation(lat, lng) {
        currentLat = lat;
        currentLng = lng;
        if(sensorMarker) sensorMarker.setLatLng([lat, lng]);
        if(sensorCircle) sensorCircle.setLatLng([lat, lng]);
        if(map) map.setView([lat, lng], 16);
      }

      function startPollutionTimer(){
        function fetchSnapshot(){
          $.getJSON('/api/data')
            .done(function(resp){
              const latest = (resp && resp.latest) || (resp && Array.isArray(resp.sensor_data) ? resp.sensor_data[0] : null);
              if(pollutionControl){
                pollutionControl.update(latest);
              }
            })
            .fail(function(){
              if(pollutionControl){
                pollutionControl.update(null);
              }
            });
        }
        if(mapPollTimer){
          clearInterval(mapPollTimer);
        }
        fetchSnapshot();
        mapPollTimer = setInterval(fetchSnapshot, MAP_POLL_INTERVAL);
      }

      function stopPollutionTimer(){
        if(mapPollTimer){
          clearInterval(mapPollTimer);
          mapPollTimer = null;
        }
      }

      function locateUser() {
        if (!navigator.geolocation) {
          currentLocationName = 'Location unavailable';
          updateLatest({latest: last});
          return;
        }
        currentLocationName = 'Detecting location…';
        updateLatest({latest: last});
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            updateMapLocation(lat, lng);
            
            $.getJSON('/api/reverse_geocode', { lat: lat, lon: lng })
              .done(function(resp) {
                const data = resp && resp.result ? resp.result : resp;
                if(data) {
                    currentLocationName = formatLocationLabel(data, 'Your location', null, { lat: lat, lon: lng });
                } else {
                    currentLocationName = 'Your location';
                }
                updateLatest({latest: last});
                if(sensorMarker) sensorMarker.openPopup();
              })
              .fail(function(){
                currentLocationName = 'Your location';
                updateLatest({latest: last});
              });
        }, function(error) {
            console.log("Geolocation failed: " + error.message);
            currentLocationName = 'Location unavailable';
            updateLatest({latest: last});
        });
      }

      function selectGeocodeResult(result) {
        if(!result) return;
        var lat = parseFloat(result.lat);
        var lon = parseFloat(result.lon);
        if(isNaN(lat) || isNaN(lon)) return;
        updateMapLocation(lat, lon);
        currentLocationName = formatLocationLabel(result, 'Selected location', lastSearchQuery, { lat: lat, lon: lon });
        updateLatest({latest: last});
        if(sensorMarker) sensorMarker.openPopup();
        hideGeocodeResults();
      }

      function showGeocodeResults(results) {
        geocodeResultsData = Array.isArray(results) ? results : [];
        const $list = $('#geocodeResults');
        if(!geocodeResultsData.length) {
          $list.removeClass('show').empty();
          return;
        }
        const html = geocodeResultsData.map(function(item, idx){
          const title = (item.display_name || '').split(',')[0] || 'Result';
          const subtitle = item.display_name || '';
          return `<button type="button" class="geocode-result" data-index="${idx}"><strong>${escapeHtml(title)}</strong><span>${escapeHtml(subtitle)}</span></button>`;
        }).join('');
        $list.html(html).addClass('show');
      }

      function hideGeocodeResults() {
        $('#geocodeResults').removeClass('show').empty();
        geocodeResultsData = [];
      }

      function searchLocation() {
        var query = $('#locationSearch').val();
        if(!query) {
          hideGeocodeResults();
          return;
        }
        query = query.trim();
        if(!query) {
          hideGeocodeResults();
          return;
        }
        lastSearchQuery = query;
        hideGeocodeResults();
        var $btn = $('#searchBtn');
        var originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        var baseParams = { q: query };
        var boundedParams = null;
        if(map && typeof map.getBounds === 'function'){
          const bounds = map.getBounds();
          if(bounds){
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            if(ne && sw){
              boundedParams = {
                q: query,
                viewbox: [sw.lng, ne.lat, ne.lng, sw.lat].join(','),
                bounded: 1
              };
            }
          }
        }

        var pendingRequests = 0;
        var attemptedFallback = false;

        function handleResults(results){
          if(results.length === 0) {
            alert('Location not found');
            return;
          }
          if(results.length === 1) {
            selectGeocodeResult(results[0]);
            return;
          }
          showGeocodeResults(results);
        }

        function requestGeocode(params, allowFallback){
          pendingRequests++;
          $.getJSON('/api/geocode', params)
            .done(function(resp){
              const results = resp && resp.results ? resp.results : [];
              if(results.length === 0 && allowFallback && !attemptedFallback){
                attemptedFallback = true;
                requestGeocode(baseParams, false);
                return;
              }
              handleResults(results);
            })
            .fail(function(){
              if(allowFallback && !attemptedFallback){
                attemptedFallback = true;
                requestGeocode(baseParams, false);
                return;
              }
              alert('Search failed. Please try again.');
            })
            .always(function(){
              pendingRequests--;
              if(pendingRequests <= 0){
                $btn.prop('disabled', false).html(originalHtml);
              }
            });
        }

        if(boundedParams){
          requestGeocode(boundedParams, true);
        } else {
          requestGeocode(baseParams, false);
        }
      }

      if($reportInput.length){
        $reportInput.off('change').on('change', function(){
          const file = this.files && this.files[0];
          if(file){
            uploadHealthReport(file);
          } else {
            setReportStatus('No file selected.', 'text-muted');
          }
        });
      }

      // Wire up buttons
      $('#locateBtn').off('click').on('click', locateUser);
      $('#searchBtn').off('click').on('click', searchLocation);
      $('#locationSearch').off('keypress').on('keypress', function(e) {
        if(e.which === 13) {
          e.preventDefault();
          if(geocodeResultsData.length) {
            selectGeocodeResult(geocodeResultsData[0]);
          } else {
            searchLocation();
          }
        }
      });
      $('#locationSearch').off('input').on('input', function() {
        if(!this.value.trim()) {
          hideGeocodeResults();
        }
      });
      $('#geocodeResults').off('click').on('click', '.geocode-result', function() {
        const idx = parseInt($(this).data('index'), 10);
        if(!isNaN(idx) && geocodeResultsData[idx]) {
          selectGeocodeResult(geocodeResultsData[idx]);
        }
      });
      $(document).on('click', function(e) {
        if(!$(e.target).closest('.search-wrapper').length) {
          hideGeocodeResults();
        }
      });

      // Modal Events - Init map only when shown
      var mapModal = document.getElementById('mapModal');
      mapModal.addEventListener('shown.bs.modal', function () {
        hideGeocodeResults();
        initMap();
        startPollutionTimer();
        locateUser();
      });
      mapModal.addEventListener('hidden.bs.modal', function () {
        hideGeocodeResults();
        stopPollutionTimer();
      });
      var growthModalEl = document.getElementById('growthModal');
      if(growthModalEl){
        growthModalEl.addEventListener('shown.bs.modal', function () {
          function showChart(){
            ensureGrowthChart();
            if(growthChart){
              updateGrowthChart(growthSeries);
              growthChart.resize();
            }
          }
          if(growthSeries.length === 0){
            refreshGrowthSeriesFromApi(showChart);
          } else {
            showChart();
          }
        });
      }

      function flashChange($el){
        $el.addClass('highlight');
        setTimeout(() => $el.removeClass('highlight'), 1000);
      }

      function updateLatest(data){
        const latest = data.latest || {};
        const t = (latest.Temperature === null || latest.Temperature === undefined) ? '—' : latest.Temperature;
        const h = (latest.Humidity === null || latest.Humidity === undefined) ? '—' : latest.Humidity;
        const g = (latest.Gas === null || latest.Gas === undefined) ? '—' : latest.Gas;
        const ts = latest.timestamp || '—';

        if(String(t) !== String(last.Temperature)){
          $('#temp').text(t);
          flashChange($('#temp'));
        }
        if(String(h) !== String(last.Humidity)){
          $('#hum').text(h);
          flashChange($('#hum'));
        }
        if(String(g) !== String(last.Gas)){
          $('#gas').text(g);
          flashChange($('#gas'));
        }

        // compute status from gas value and update badge
        function statusForGas(gval){
          try{
            const gv = parseFloat(gval);
            if(!isFinite(gv)) return 'normal';
            if(180 <= gv && gv < 380) return 'safe';
            if(380 <= gv && gv <= 1024) return 'unsafe';
            return 'normal';
          }catch(e){ return 'normal'; }
        }

        const newStatus = statusForGas(g);
        
        // Always update the badge and circle color based on current status
        let badge = `<span class="status-badge bg-secondary text-white">${newStatus}</span>`;
        const ns = String(newStatus).toLowerCase();
        let circleColor = 'grey';
        
        if(ns === 'safe') {
          badge = `<span class="status-badge bg-success text-white">Safe</span>`;
          circleColor = '#4ade80'; // success-color
        }
        else if(ns === 'unsafe') {
          badge = `<span class="status-badge bg-danger text-white">Unsafe</span>`;
          circleColor = '#ef4444'; // danger-color
        }
        else if(ns === 'normal') {
          badge = `<span class="status-badge bg-warning text-dark">Normal</span>`;
          circleColor = '#f59e0b'; // warning-color
        }
        
        $('#status').html(badge);
        
        // Update map circle color
        if(sensorCircle) {
          sensorCircle.setStyle({
              color: circleColor,
              fillColor: circleColor
          });
        }

        if(String(ts) !== String(last.timestamp)){
          $('#timestamp').text(ts);
        }

        // Update map popup
        const safeLocation = escapeHtml(currentLocationName || 'Selected location');
        var popupContent = `
            <div style="text-align:center">
                <b>${safeLocation}</b><br>
                <hr style="margin:5px 0">
                Temp: <b>${t}°C</b> | Hum: <b>${h}%</b><br>
                Gas: <b>${g} ppm</b><br>
                <span class="badge ${newStatus === 'safe' ? 'bg-success' : (newStatus === 'unsafe' ? 'bg-danger' : 'bg-warning text-dark')}">${newStatus.toUpperCase()}</span>
            </div>
        `;
        sensorMarker.setPopupContent(popupContent);
        
        // Update info control
        if(infoControl) infoControl.update();

        last = { 
          Temperature: t, 
          Humidity: h, 
          Gas: g, 
          timestamp: ts, 
          status: (typeof newStatus !== 'undefined' ? newStatus : last.status) 
        };
        if(Array.isArray(data.sensor_data)){
          growthSeries = data.sensor_data.slice();
          if(growthChart){
            updateGrowthChart(growthSeries);
          }
        }
      }

      function poll(){
        $.getJSON("/api/data")
          .done(function(resp){
            updateLatest(resp);
          })
          .fail(function(){
            // silently ignore for now
          });
      }

      // Manual AI analysis handler
      function runAnalysis(){
        const btn = $('#runAnalysisBtn');
        // disable button while running
        btn.prop('disabled', true);
        $('#aiSpinner').show();
        // clear previous email status
        $('#aiEmailResult').text('Sending...');
        
        $.ajax({ url: '/api/auto_analyze', method: 'POST' })
          .done(function(resp){
            if(!resp || !resp.analyses){
              $('#aiLatest').text('No analyses returned.');
              return;
            }
            
            // show the analyses and prepend rows to table
            for(let i=0; i<resp.analyses.length; i++){
              const a = resp.analyses[i];
              const id = a.id;
              
              const getStatusBadge = (s) => {
                if(!s) return `<span class="badge bg-secondary">—</span>`;
                const ss = String(s).toLowerCase();
                if(ss === 'safe') return `<span class="badge bg-success">Safe</span>`;
                if(ss === 'unsafe') return `<span class="badge bg-danger">Unsafe</span>`;
                if(ss === 'normal') return `<span class="badge bg-warning text-dark">Normal</span>`;
                return `<span class="badge bg-secondary">${s}</span>`;
              };

              if($('#row-'+id).length === 0){
                const row = `<tr id="row-${id}">`+
                  `<td>${id}</td>`+
                  `<td>${a.disease || ''}</td>`+
                  `<td>${a.temperature == null ? '—' : a.temperature}</td>`+
                  `<td>${a.humidity == null ? '—' : a.humidity}</td>`+
                  `<td>${a.gas == null ? '—' : a.gas}</td>`+
                  `<td>${getStatusBadge(a.status)}</td>`+
                  `<td style="max-width:320px;white-space:pre-wrap;">${a.result || ''}</td>`+
                  `<td>${a.timestamp}</td>`+
                  `</tr>`;
                $('table.table tbody').prepend(row);
              }
            }

            const details = resp.details || (resp.analyses[0] && resp.analyses[0].details) || null;
            if(details){
              $('#aiLatest').html(renderAnalysisDetails(details)).removeClass('ai-result-empty').addClass('ai-result-ready');
              $('#aiLastTime').text(details.timestamp || (resp.analyses[0] && resp.analyses[0].timestamp) || '—');
            } else if(resp.analyses.length > 0){
              const first = resp.analyses[0];
              $('#aiLatest').text((first.status ? ('Status: ' + first.status + '\n') : '') + (first.result || 'No analysis result'));
              $('#aiLastTime').text(first.timestamp || '—');
            }

            // show email send result if present
            if(typeof resp.email_sent !== 'undefined'){
              if(resp.email_sent){
                $('#aiEmailResult').text('Sent ✓');
              } else {
                $('#aiEmailResult').text('Failed: ' + (resp.email_info || 'see server logs'));
              }
            } else {
              $('#aiEmailResult').text('Unknown');
            }
          })
          .fail(function(){
            $('#aiLatest').text('Analysis failed. Check server logs.');
            $('#aiEmailResult').text('Failed: request error');
          })
          .always(function(){
            $('#aiSpinner').hide();
            // cooldown: re-enable button after 30s to avoid spamming the GenAI API
            setTimeout(function(){ btn.prop('disabled', false); }, 30000);
          });
      }

      // Start polling immediately and on interval
      poll();
      setInterval(poll, POLL_INTERVAL);
      fetchHealthReports();
      locateUser();
      
      // wire up the Run AI Analysis button
      $('#runAnalysisBtn').on('click', function(){ runAnalysis(); });
    });
  </script>
</body>
</html>